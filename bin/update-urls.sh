#!/usr/bin/env bash
set -e

# update-urls.sh Formula/act3-pt.rb "$(formulize...)"

# Path to formula to update
FORMULA=$1

# Argument is block containing the updated URLs and checksums for the formula
URL_BLOCK=$2

# Fail fast here
if ! grep "require" "${FORMULA}" | grep -q "registry_download"; then
	echo "Formula ${FORMULA} does not import the download strategy file, leaving unchanged."
	exit 1
fi

([[ -f newformula.rb ]] && rm newformula.rb) && touch newformula.rb
while IFS= read -r line; do
	# Skip the "Generated by" comment
	comment="# Generated by https://git.act3-ace.com/ace/homebrew-ace-tools/-/blob/master/bin/formulize.sh"
	[[ "${line}" =~ \ *${comment} ]] && continue

	# Iterate to on_macos block
	if [[ "${line}" =~ .*on_macos\ do.* ]]; then
		echo "${URL_BLOCK}" >>newformula.rb
		end1="false"

		# Iterate into on_linux block
		while IFS= read -r line; do
			[[ "${line}" =~ .*on_linux\ do.* ]] && break
		done

		# Iterate to two end statements in a row
		while IFS= read -r line; do
			[[ "${line}" =~ \ *end\ * ]] && [[ "${end1}" == "true" ]] && break
			if [[ "${line}" =~ \ *end\ * ]]; then
				end1="true"
			else
				end1="false"
			fi
		done
	else
		echo "${line}" >>newformula.rb
	fi
done <"${FORMULA}"

mv -f newformula.rb "${FORMULA}"
